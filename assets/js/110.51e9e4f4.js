(window.webpackJsonp=window.webpackJsonp||[]).push([[110],{491:function(t,a,s){"use strict";s.r(a);var n=s(26),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"插件机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件机制"}},[t._v("#")]),t._v(" "),s("H2Icon"),t._v(" 插件机制")],1),t._v(" "),s("blockquote",[s("p",[t._v("本小节让我们来详细介绍一下 Lin 的精髓——插件机制")])]),t._v(" "),s("h2",{attrs:{id:"插件的规范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件的规范"}},[t._v("#")]),t._v(" 插件的规范")]),t._v(" "),s("p",[t._v("首先，我们通过 Lin 的默认 logger 插件来看看插件的目录规范和开发规范。")]),t._v(" "),s("h3",{attrs:{id:"目录规范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目录规范"}},[t._v("#")]),t._v(" 目录规范")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("├───logger\n│   │   config.py // 配置文件，记录关于插件的可用配置，所有配置项名均为大写，与starter项目的配置规范一致\n│   │\n│   └───app // app目录开发\n│           controller.py  // 控制层，每个控制层文件要求只有一个红图实例，当然你可以将文件名换成你喜欢的名字，而且你也可以拥有多个红图实例文件\n│           forms.py // 校验层，存放校验类文件\n│           log.py // 日志核心类库，插件的核心文件，如logger插件的核心文件为log.py，当然你也可有多个核心文件\n│           model.py // 模型层，数据库模型类\n│           __init__.py // 导出文件。重要！！！\n")])])]),s("p",[t._v("Lin 的插件可能与你以前了解的插件概念不一样，"),s("em",[t._v("你可以把每个插件理解为一个小 app")]),t._v("。每个插件都有自己的配置、控制层、模型层甚至校验层，换言之每个插件都有自己的业务，它的概念很像"),s("strong",[t._v("微服务")]),t._v("，即每个插件只负责完成某一项功能。")]),t._v(" "),s("h3",{attrs:{id:"开发规范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发规范"}},[t._v("#")]),t._v(" 开发规范")]),t._v(" "),s("p",[t._v("由于插件本身就是一个微型的 app，插件的开发规范与项目的开发规范几乎一致，如果你还不够熟悉，那么请你再次阅读"),s("RouterLink",{attrs:{to:"/abandon/structure_and_specification.html"}},[t._v("开发规范")]),t._v("。")],1),t._v(" "),s("p",[t._v("当然，插件这里也有一个自己独特的机制——加载。在前面，我们在介绍项目开发时，红图以及模型都是我们主动去通过"),s("code",[t._v("import")]),t._v("导入的。但是在插件中，我们可以不用做这件事情，因为 Lin 会自动通过 loader（加载器）来帮我们做这件事。")]),t._v(" "),s("p",[t._v("所以，在你开发的插件中，你必须明确告诉 loader，因为 loader 真的不够聪明，它到底该加载哪些东西。而"),s("code",[t._v("logger/app/__init__.py")]),t._v("这个文件则扮演这个角色，它里面的代码很简单，如下：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("controller "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" log_api\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("model "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Log\n")])])]),s("p",[t._v("在代码的第一行，我们从当前目录中的"),s("code",[t._v("controller")]),t._v("导入了"),s("code",[t._v("log_api")]),t._v("这个红图，第二行从"),s("code",[t._v("model")]),t._v("中导入了"),s("code",[t._v("Log")]),t._v("这个模型类。而后，loader 会自动的从"),s("code",[t._v("__init__.py")]),t._v("文件得到刚才导出的"),s("code",[t._v("log_api")]),t._v("和"),s("code",[t._v("Log")]),t._v("，然后存储到自身的容器中。")]),t._v(" "),s("p",[t._v("当然，在"),s("code",[t._v("__init__.py")]),t._v("你可以导入多个的红图和模型，如你还可能需要加载另外一个红图"),s("code",[t._v("some_api")]),t._v("和另外一个模型"),s("code",[t._v("Some")]),t._v("，接下来你应该在上段的代码中加入：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("some "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" some_api\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("model "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Some\n")])])]),s("p",[t._v("被 loader 加载红图会被直接挂载到默认的 CMS 蓝图中，你可通过相应的 url 直接访问。而加载的模型你可通过如下的方式得到：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" manager "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到manager")]),t._v("\nLog "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" manager"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_model"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Log'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到加载到容器中的Log模型")]),t._v("\n")])])]),s("p",[t._v("当然如果你不喜欢这种方式，你也可以通过"),s("code",[t._v("import")]),t._v("方式得到这个模型：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plugins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("model "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Log\n")])])]),s("h2",{attrs:{id:"插件的加载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件的加载"}},[t._v("#")]),t._v(" 插件的加载")]),t._v(" "),s("p",[t._v("在"),s("RouterLink",{attrs:{to:"/abandon/run_process.html"}},[t._v("运行流程")]),t._v("一节中我们留下了一个悬念，那就是插件的加载流程。在 Lin 源代码中，可以在 Manager 的构造函数中找到如下代码段：")],1),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loader "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Loader\nself"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Loader "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Loader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plugin_path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("这里初始化的 loader （插件加载器），由它来负责所有插件的加载，我们继续打开 Loader 的构造函数。")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__init__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" plugin_path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plugins "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plugin_path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'plugin_path must be a dict'")]),t._v("\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plugin_path "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" plugin_path\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load_default_plugins_config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加载内置插件的配置")]),t._v("\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load_plugins_config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加载插件的配置")]),t._v("\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load_default_plugins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加载内置的插件")]),t._v("\n    self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load_plugins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加载其它插件")]),t._v("\n")])])]),s("p",[t._v("这里大致的流程是这样的，loader 率先加载内置插件的配置，然后加载其它插件的配置，随后加载内置的插件，最后加载其它插件。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-----------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 加载内置插件配置 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  ----"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 加载插件配置 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  ----"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 加载内置插件 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  ----"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 加载其它插件 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-----------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("--------------"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n")])])]),s("p",[t._v("接下来我们继续，在 Loader 类中还有两个方法"),s("code",[t._v("_load_plugin")]),t._v("和"),s("code",[t._v("_load_config")]),t._v("，这两个方法是 loader 的核心方法，由它们向容器中加载插件和插件配置。这两个方法的思路很明确，我们相信你完全可以阅读"),s("a",{attrs:{href:"loader.py"}},[t._v("源代码")]),t._v("来理解。")]),t._v(" "),s("p",[t._v("好，插件的整体流程的梳理到此已经结束了。如果你感到疑惑，请记住 loader 的加载本身只是一个很简单的过程，当你亲身通过断点 Debug 的方式去运行程序时，你就会觉得豁然开朗。")]),t._v(" "),s("h2",{attrs:{id:"插件的开发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件的开发"}},[t._v("#")]),t._v(" 插件的开发")]),t._v(" "),s("p",[t._v("TODO")]),t._v(" "),s("RightMenu")],1)}),[],!1,null,null,null);a.default=r.exports}}]);