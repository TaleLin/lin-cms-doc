(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{437:function(t,s,a){"use strict";a.r(s);var n=a(26),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"模型管理和权限管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模型管理和权限管理"}},[t._v("#")]),t._v(" "),a("H2Icon"),t._v(" 模型管理和权限管理")],1),t._v(" "),a("blockquote",[a("p",[t._v("阅读本小节前，请确保你一定完成了"),a("RouterLink",{attrs:{to:"/0.2.x/start/flask/"}},[t._v("快速开始")]),t._v("的全部内容\n本小结使用"),a("code",[t._v("postman")]),t._v("作为 http 测试工具，请确保你有 postman 或类似的 http 测试工具，它是我们后续开发必不可少的工具。")],1)]),t._v(" "),a("h2",{attrs:{id:"权限管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#权限管理"}},[t._v("#")]),t._v(" 权限管理")]),t._v(" "),a("h3",{attrs:{id:"架构介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构介绍"}},[t._v("#")]),t._v(" 架构介绍")]),t._v(" "),a("p",[t._v("Lin 的定位是一整套的 Flask CMS 解决方案。对于任何的 CMS 来说，权限这一块都是"),a("strong",[t._v("不可或缺")]),t._v("的，因此 Lin 在基础框架中便已经集成了权限模块，它是开箱即用的。")]),t._v(" "),a("p",[t._v("不过 Lin 的权限模块的概念可能与其它的权限框架由些许不同，当然你完全不用担心，因为大部分权限系统的模式都大同小异。")]),t._v(" "),a("p",[t._v("在 Lin 的权限模块中，我们有三个模型类来组成这个这个权限模块。如下：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("用户模型（user_model，数据表名称为 lin-user）\n用户是权限系统服务的基本单位，CMS 与一些网站的很大的区别在于，CMS 可能不存在不用登陆便可进入的页面（登陆页除外）。")]),t._v(" "),a("p",[t._v("简而言之，用户是必须的。在源代码"),a("code",[t._v("lin/core.py")]),t._v("可以找到"),a("code",[t._v("User")]),t._v("这个类。User 类实则是一个数据库模型类，它有一些必要的属性和实用的方法。")])]),t._v(" "),a("li",[a("p",[t._v("权限组模型（group_model，数据表名称为 lin-group）\n权限组是一个非常重要的概念，权限组是权限分配的基本单位，同时它也是容纳用户的容器，它是用户与权限之间的纽带。")]),t._v(" "),a("p",[t._v("一个用户只能属于一个权限组，超级管理员（super）不属于任何权限组，但超级管理员拥有所有的权限，一个权限组可以拥有多个用户。")]),t._v(" "),a("p",[t._v("权限组也可拥有多个权限，也就是说，在某个权限组的用户拥有该权限组的所有权限。")]),t._v(" "),a("p",[t._v("如果，你还不清楚，请你在源代码"),a("code",[t._v("lin/core.py")]),t._v("中阅读"),a("code",[t._v("Group")]),t._v("这个类的属性。")])]),t._v(" "),a("li",[a("p",[t._v("权限模型（auth_model，数据表名称为 lin-auth）\n你可以把一个权限理解成一把钥匙，然你拥有这把钥匙的时候你就可以打开某扇门，而当你没有这把钥匙的时候，你就会被锁在门的外面。")]),t._v(" "),a("p",[t._v("所以对于某个用户，比如说：你，当你拥有某个权限时，你就可以访问某个 API（或多个 API），而当你没有这个权限时，你访问 API 时会得到一个授权失败或禁止的信息。")]),t._v(" "),a("p",[t._v("想了解更详细的细节，请查看源代码"),a("code",[t._v("lin/core.py")]),t._v("中"),a("code",[t._v("Auth")]),t._v("这个类。")])])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("上述中的源代码，请在第三方包"),a("code",[t._v("lin-cms")]),t._v("中寻找。")])]),t._v(" "),a("h3",{attrs:{id:"基本使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本使用"}},[t._v("#")]),t._v(" 基本使用")]),t._v(" "),a("p",[t._v("接下来，就让我们开始实战了。请先在"),a("code",[t._v("app/v1/book.py")]),t._v("中添加如下一个删除图书功能的 API。")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exception "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" NotFound"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Success\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" route_meta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" group_required\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 省略很多行代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@book_api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/<id>'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" methods"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DELETE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@route_meta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将这个视图函数注册到权限管理容器中；auth的名称为 `删除图书` 模块名为 `图书`")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@group_required")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 只有在权限组授权后才可访问")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete_book")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Book "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_by"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("raise")]),t._v(" NotFound"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'没有找到相关书籍'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("commit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Success"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除图书成功'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("在快速开始一节中已经在数据中创建了一个超级管理员的账号，为了更好的测试，我们还需要一个普通用户的账号，接下来我们把"),a("code",[t._v("fake.py")]),t._v("的内容更换为如下内容：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" create_app\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Book\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("db "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" db\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Auth\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" create_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app_context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auto_commit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        group "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'普通分组'")]),t._v("\n        group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'就是一个分组而已'")]),t._v("\n        db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flush"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("username "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pedro'")]),t._v("\n        user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("password "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'123456'")]),t._v("\n        user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'123456780000@qq.com'")]),t._v("\n        db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        auth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除图书'")]),t._v("\n        auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'图书'")]),t._v("\n        auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("group_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("id")]),t._v("\n        db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("如果你仔细理解了上面架构介绍，这段代码的作用便是创建一个权限（删除图书），一个用户（pedro），一个权限组（普通分组）；且权限与权限组已经绑定了，不过新建的用户却未与权限组关联，这个新建权限就是上段代码中的删除图书的 API。")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("这里，虽然新建了"),a("code",[t._v("pedro")]),t._v("这个用户，但是他却没有"),a("em",[t._v("删除图书")]),t._v("这个权限。")])]),t._v(" "),a("p",[t._v("请在 postman 的 url 地址栏输入"),a("code",[t._v("http://127.0.0.1:5000/cms/user/login")]),t._v("，请求方法选择 post 方法，并在请求参数的 body 里面填入下面数据：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"username"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"super"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("如果顺利，你会得到如下返回结果：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"access_token"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1NDAxMzM0NjAsIm5iZiI6MTU0MDEzMzQ2MCwianRpIjoiYTlmMWIzNTYtMzI3ZS00MjcyLWE0MTUtZWU5YTliOGRjYTUxIiwiZXhwIjoxNTQwMjE5ODYwLCJpZGVudGl0eSI6InN1cGVyIiwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.xXTxkadyPqZDvL6G7YyNF-H7hHgAopI57W1cLI586vs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"refresh_token"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1NDAxMzM0NjAsIm5iZiI6MTU0MDEzMzQ2MCwianRpIjoiNDFhOTVhMjMtODk4MC00NzA4LWIzYzgtODBlYWFlMzU3ZTZjIiwiZXhwIjoxNTQyNzI1NDYwLCJpZGVudGl0eSI6InN1cGVyIiwidHlwZSI6InJlZnJlc2gifQ.ZZQ-RPtFYSOx_Jp6jv1g0iUP0g4Qw-ylf13YYipMim0"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("img-wrapper",[a("img",{attrs:{src:"https://cdn.talelin.com/lin/docs/authority_and_models1.png"}})]),t._v(" "),a("p",[t._v("到此，我们拿到了访问 API 所必须的令牌，请记住这是超级管理员的令牌，它可以访问一切 API。接下来我们访问改变 postman 的 url 地址为")]),t._v(" "),a("p",[a("code",[t._v("http://127.0.0.1:5000/cms/admin/authority")]),t._v("，并且在请求头中加入键值对。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 此处的access_token是变量，为上面返回结果的access_token")]),t._v("\nAuthorization: Bearer "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${access_token}")]),t._v("\n")])])]),a("p",[t._v("结果为：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 图书模块")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"图书"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 一个权限")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"删除图书"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1.book+delete_book"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 权限下的endpoint")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  省略......\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("请记住以"),a("code",[t._v("/admin")]),t._v("为前缀的 url 一般为超级管理员专有，需要以超级管理员账号申请令牌才可访问。")]),t._v(" "),a("img-wrapper",[a("img",{attrs:{src:"http://imglf3.nosdn0.126.net/img/Qk5LWkJVWkF3NmdYN2FJcVlYMkpSVG1VZWNYUUt4M1d6RkkvY3NnU2w2Wnp0Z1dtdFIzRWVnPT0.png?imageView&thumbnail=1680x0&quality=96&stripmeta=0"}})]),t._v(" "),a("p",[t._v("如果你顺利得到了结果，你可能不明白这些数据究竟代表着什么。这没关系，我们会一一说明，不过在此之前，你的先了解一个概念，那就是 Flask 中的"),a("strong",[t._v("endpoint(端点)")]),t._v("。")]),t._v(" "),a("p",[t._v("无论你是否熟悉 Flask，在这里，一个 endpoint 所能起到的作用那便是——"),a("em",[t._v("唯一标识一个视图函数，或者说一个 url，一个 API(严格来说 API 不等同于一个视图函数，但是在大多数的开发中，一个视图函数确实与一个 API 对应)")]),t._v("。")]),t._v(" "),a("p",[t._v("在刚才的返回结果中，我们可以找到"),a("code",[t._v("v1.book+delete_book")]),t._v("这个字段，这个字段就是一个"),a("strong",[t._v("endpoint")]),t._v("。也就是说，这个端点标识了一个视图函数，而"),a("strong",[t._v("删除图书")]),t._v("代表的是这个权限的名称。聪明的你会发现，一个权限可以拥有多个端点，换言之那就是一个权限可以对应多个视图函数。当然一般情况下，一个权限对应一个视图函数，我们也强烈推荐你这么做。")]),t._v(" "),a("p",[a("strong",[t._v("删除图书")]),t._v("这个权限它还有一个重要的属性，那就是模块（module），也就是"),a("strong",[t._v("图书")]),t._v("这个字段。")]),t._v(" "),a("p",[t._v("之所以需要这个属性，是因为权限一旦多了之后，你可能无法很好的梳理它们之间的关联，而有了模块这个概念之后，你可以很好的区分哪些权限属于哪一个模块，在前端操作界面，当管理员进行操作的时候，这也会为他提供诸多便利。")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("开发者请注意，此处的"),a("strong",[t._v("删除图书")]),t._v("权限和"),a("strong",[t._v("图书")]),t._v("模块对应的是上述添加视图函数中的")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@route_meta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将这个视图函数注册到权限管理容器中；auth的名称为 `删除图书` 模块名为 `图书`")]),t._v("\n")])])]),a("p",[t._v("这一行代码，也就是说，权限的命名和分配均是由开发者自己来斟酌，如果你们是团队协作，请与你们的前端、客户仔细交流再做决定。")])]),t._v(" "),a("p",[t._v("上面，我们添加了一个"),a("code",[t._v("delete_book")]),t._v("的 API，其对应的 url 为"),a("code",[t._v("http://127.0.0.1:5000/v1/book/1")]),t._v("，请求方法为"),a("code",[t._v("delete")]),t._v("。如果此时，你以超级管理员的 token 进行操作，那么毫无疑问，这个 id 为 1 的图书会被删除。但是绝大多数情况下，我们不能让别人直接以超级管理员的身份来操作，这太危险了！！！")]),t._v(" "),a("p",[t._v("聪明的你又会发现，我们刚刚不是已经申请了一个名为"),a("code",[t._v("pedro")]),t._v("的用户吗？而且他还未被分配到任何权限组（请注意，我们非常不推荐存在离群用户，即没有被分配到权限组的用户，超级管理员除外，此处我们仅仅是为了方便测试而未直接给 pedro 用户分配权限组），因此理论上说 pedro 并没有访问"),a("code",[t._v("delete_book")]),t._v("的权限，那么实际如何了。")]),t._v(" "),a("p",[t._v("我们通过 pedro 的账号名、密码登陆获取令牌，并将 header 中的 Authorization 字段换成相应的令牌字段。而后访问"),a("code",[t._v("http://127.0.0.1:5000/v1/book/1")]),t._v("，你会得到如下结果：")]),t._v(" "),a("img-wrapper",[a("img",{attrs:{src:"https://cdn.talelin.com/lin/docs/authority_and_models3.png"}})]),t._v(" "),a("p",[t._v("现在权限系统已经开始显现它的威能了。它告诉我们，pedro 这个用户未被分配权限组，并没有权限能够访问这个 API。既然没有权限，那我们便分配这个权限给 pedro（请注意，这里分配权限仅为了测试方便，一般的只允许超级管理员分配）。")]),t._v(" "),a("p",[t._v("打开"),a("code",[t._v("fake.py")]),t._v("文件，换成如下代码：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" create_app\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Book\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("db "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" db\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Group"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Auth\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" create_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app_context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auto_commit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        pedro"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" User "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_by"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pedro'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注意：此处的group_id为刚才新建group的id，一般情况下它确实为1")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果你以前有新建其它权限组，可能它的id不是1，所以请你先确定它的id")]),t._v("\n        pedro"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" commit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("运行它后，pedro 用户便被分配到了 id 为 1 的这个权限组。接下来，我们再次访问"),a("code",[t._v("http://127.0.0.1:5000/v1/book/1")]),t._v("，结果如下：")]),t._v(" "),a("img-wrapper",[a("img",{attrs:{src:"https://cdn.talelin.com/lin/docs/authority_and_models4.png"}})]),t._v(" "),a("p",[t._v("如果你也是一样的结果，那么恭喜你，你已经完成了一个权限开发的全部流程，再你后续的开发过程中，都是类似的做法来完成全部的权限管理开发。")]),t._v(" "),a("p",[t._v("在刚才，我们提到了一点。一个权限是可以拥有多个视图函数的，下面我们来亲身实践一下。")]),t._v(" "),a("p",[t._v("我们新增一个删除多个图书的 API——"),a("code",[t._v("delete_books")]),t._v("。"),a("code",[t._v("delete_books")]),t._v("与"),a("code",[t._v("delete_book")]),t._v("同属于一个权限，聪明的你肯定已经想到了，用户 pedro 也应该能够访问这个 API。")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@book_api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/patch'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" methods"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DELETE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@route_meta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'图书'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@group_required")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete_books")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    books "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_by"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" books "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("books"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("raise")]),t._v(" BookNotFound"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 删除所有的图书，这是一个危险的操作，请记住真正的开发时谨慎使用")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" books"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("commit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Success"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'删除所有图书成功'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("我们改变 post 的 url 为"),a("code",[t._v("http://127.0.0.1:5000/v1/book/patch")]),t._v("，点击 send 按钮，结果如下，所有的图书已被删除。")]),t._v(" "),a("img-wrapper",[a("img",{attrs:{src:"https://cdn.talelin.com/lin/docs/authority_and_models5.png"}})]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),a("p",[t._v("如果你此时打开数据库，你一定很奇怪，book 的数据并未被删除，相反它们还新增了数据"),a("code",[t._v("delete_time")]),t._v("，这是因为 Book 模型继承了 InfoCrud 这个带软删除的模型基类。")]),t._v(" "),a("p",[t._v("另外，请开发者一定仔细斟酌你的权限分配问题，适当的权限才能带来良好的管理。")])]),t._v(" "),a("h3",{attrs:{id:"守卫函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#守卫函数"}},[t._v("#")]),t._v(" 守卫函数")]),t._v(" "),a("p",[t._v("在上一节中，聪明的你一定注意到了一个"),a("code",[t._v("@group_required")]),t._v("的装饰器。我们把这它称之为"),a("strong",[t._v("守卫函数")]),t._v("。请记住，守卫函数是权限系统中非常重要的一环，在基础库中我们提供了 3 个守卫函数，分别是：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("name")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("说明")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("login_required")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("被 login_required 装饰的视图函数需登陆后才可访问")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("**")])])]),t._v(" "),a("tr",[a("td",[t._v("group_required")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("被 group_required 装饰的视图函数需登陆且被授予相应的权限后才可访问")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("**")])])]),t._v(" "),a("tr",[a("td",[t._v("admin_required")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("被 admin_required 装饰的视图函数只有超级管理员才可访问")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("**")])])])])]),t._v(" "),a("p",[t._v("开发者请注意，这三个守卫函数是开发层面上权限管理。如果你的视图函数未加任何守卫函数修饰，那么它可以被任何人访问，这样的视图函数一般是登陆这些功能的视图函数。又如哪些视图函数需要用户登陆才能访问，如用户修改密码，那么它可以加上"),a("code",[t._v("login_required")]),t._v("这个守卫函数。如果有些视图函数的功能需要授予权限才能访问，请使用"),a("code",[t._v("group_required")]),t._v("。而有些视图函数非超级管理员不可操作，那么请加上"),a("code",[t._v("admin_required")]),t._v("修饰。")]),t._v(" "),a("h2",{attrs:{id:"模型管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模型管理"}},[t._v("#")]),t._v(" 模型管理")]),t._v(" "),a("p",[t._v("在权限管理的架构介绍时，我们就已经介绍了三个模型类"),a("code",[t._v("user_model")]),t._v("、"),a("code",[t._v("group_model")]),t._v("和"),a("code",[t._v("auth_model")]),t._v("。这是 Lin 里面最重要的三个模型，Lin 默认暴露的 API 和权限系统均直接依赖于这三个模型类。接下来请记住一个原则，如果你想使用这三个类，请通过"),a("code",[t._v("manager")]),t._v("来得到这三个类，而后再使用，如下：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v("  manager\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######省略代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到用户模型")]),t._v("\nmanager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user_model\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到权限组模型")]),t._v("\nmanager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("group_model\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到权限模型")]),t._v("\nmanager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth_model\n")])])]),a("p",[t._v("你可能会疑惑，为什么我们不直接通过"),a("code",[t._v("import")]),t._v("导入模型来使用，而是间接通过 manager 来访问，因为这三个核心模型默认集成在 Lin 中的，可是有时候我们需要对其中某个模型进行扩展。例如，user_model 可能还需要一个"),a("code",[t._v("phone（电话）")]),t._v("属性，那么我们就必须扩展该模型，因此你就需要改变这个 user_model，所以我们才把 user_model 挂载到 manager 中。")]),t._v(" "),a("h3",{attrs:{id:"扩展模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#扩展模型"}},[t._v("#")]),t._v(" 扩展模型")]),t._v(" "),a("p",[t._v("刚刚我们谈到扩展模型，接下来让我们来实操一下如何扩展 user_model。首先我们在"),a("code",[t._v("app/models")]),t._v("下新建"),a("code",[t._v("user.py")]),t._v("文件，并添加如下代码：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" _User\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sqlalchemy "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" String\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 扩展user，增加一个phone属性")]),t._v("\n    phone "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" unique"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("接下来，我们修改"),a("code",[t._v("app/app.py")]),t._v("文件中的 create_app 函数：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Flask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app.config.setting'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app.config.secure'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    register_blueprints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User\n    Lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_model"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    apply_cors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建所有表格")]),t._v("\n    create_tables"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" app\n")])])]),a("p",[t._v("由于 flask-sqlalchemy 的特性，当数据库中有 lin-user 这张表时，它并不会直接更新这张表。所以为了确保扩展成功，请你在数据库中先删除掉 lin-user 这张表，然后再次运行"),a("code",[t._v("starter.py")]),t._v("文件。如果，一切顺利你会在数据库中看到 lin-user 这张表多了一个"),a("code",[t._v("phone")]),t._v("字段。到这里，我们的模型扩展已经成功了，为了确保我们的 manager 可以访问到新的 user_model，我们在"),a("code",[t._v("fake.py")]),t._v("文件中写入如下代码测试（首先请确保你的 lin-user 表中已经有 super 这个用户了）：")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" create_app\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Book\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("db "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" db\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" lin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" manager\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" create_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app_context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auto_commit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        pedro "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" manager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user_model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filter_by"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'super'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        pedro"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("phone"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("197868758987")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" commit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("运行后，你将会在数据库中看到 super 用户的 phone 字段已经为"),a("code",[t._v("197868758987")]),t._v("了。")]),t._v(" "),a("h2",{attrs:{id:"infocrud-和-basecrud"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#infocrud-和-basecrud"}},[t._v("#")]),t._v(" InfoCrud 和 BaseCrud")]),t._v(" "),a("p",[t._v("Lin 默认集成了 flask-sqlalchemy 这个方便的 ORM 库，因此我们可以很好的根据模型（model）来进行相关的数据库操作。某种意义上，sqlalchemy 提供的 API 已经可以很好的操作数据库了。")]),t._v(" "),a("p",[t._v("林间有风团队在诸多项目的开发中，也同时积累了些许经验，我们希望当模型类被定义时便已经默认拥有了简单的 CRUD，因此在 Lin 中我们提供了这两个方便的基础模型类—— InfoCrud 和 BaseCrud。")]),t._v(" "),a("p",[t._v("BaseCrud 默认便拥有"),a("code",[t._v("create")]),t._v("，"),a("code",[t._v("delete")]),t._v("，"),a("code",[t._v("update")]),t._v("，"),a("code",[t._v("get")]),t._v("这些便捷方法，你可以很便捷的进行数据的增删查改。")]),t._v(" "),a("p",[t._v("InfoCrud 在 BaseCrud 的基础上，添加了"),a("code",[t._v("create_time")]),t._v("，"),a("code",[t._v("update_time")]),t._v("，"),a("code",[t._v("delete_time")]),t._v("这三个字段，方便你进行数据的分析和观察，另外 InfoCrud 还增加了"),a("code",[t._v("hard_delete")]),t._v("方法，InfoCrud 使用"),a("code",[t._v("delete_time")]),t._v("来进行数据的软删除，因此当你调用"),a("code",[t._v("delete")]),t._v("方法时，数据并不会真正的从数据库中删除，而是写入"),a("code",[t._v("delete_time")]),t._v("，所以若要真正的删除数据，需调用"),a("code",[t._v("hard_delete")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"小节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小节"}},[t._v("#")]),t._v(" 小节")]),t._v(" "),a("p",[t._v("在本节中，我们熟悉了一下权限管理的开发流程，并介绍 manager 的模型管理和扩展。")]),t._v(" "),a("p",[t._v("如果你对模型类的操作还不够了解，甚至有些疑惑，请你详细阅读"),a("a",{attrs:{href:"http://flask-sqlalchemy.pocoo.org/2.3/queries/#querying-records",target:"_blank",rel:"noopener noreferrer"}},[t._v("flask-sqlalchemy"),a("OutboundLink")],1),t._v("的官方文档，")]),t._v(" "),a("p",[t._v("和这个"),a("a",{attrs:{href:"https://www.jianshu.com/p/8d085e2f2657",target:"_blank",rel:"noopener noreferrer"}},[t._v("sqlalchemy 小教程"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("RightMenu")],1)}),[],!1,null,null,null);s.default=e.exports}}]);